<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Task Tracker with Firebase</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Define color variables for charts and consistent theming */
        :root {
            --chart-todo: #3B82F6;
            --chart-inprogress: #F59E0B;
            --chart-completed: #10B981;
            --chart-q1: #EF4444;
            --chart-q2: #3B82F6;
            --chart-q3: #F59E0B;
            --chart-q4: #6B7280;
            --card-bg-light: white;
            --card-bg-dark: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the card being dragged */
        .dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        /* Style for the column being dragged over */
        .drag-over {
            background-color: rgba(0, 0, 0, 0.05);
        }
        html.dark .drag-over {
             background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Auth Container / Loading Screen -->
    <div id="auth-container" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Kanban Task Tracker</h1>
            <p id="auth-message" class="mt-2 text-gray-600 dark:text-gray-400">Initializing...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="main-app" class="hidden p-4 md:p-8 max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Kanban Board</h1>
            <div class="flex items-center gap-4">
                <button id="themeToggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-200 dark:bg-gray-700 text-xl">🌙</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors">Logout</button>
            </div>
             <div class="w-full text-sm text-gray-500 dark:text-gray-400">
                User ID: <code id="userIdDisplay" class="bg-gray-200 dark:bg-gray-700 p-1 rounded"></code>
            </div>
        </header>

        <!-- Task Input Form -->
        <div class="mb-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Add a New Task</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="taskTitle" placeholder="Task Title (Required)" class="col-span-1 md:col-span-2 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                <textarea id="taskDescription" placeholder="Description" rows="3" class="col-span-1 md:col-span-2 p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                <input type="number" id="taskDuration" placeholder="Duration (minutes)" min="1" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                <input type="date" id="taskDueDate" class="p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500">
                <div class="col-span-1 md:col-span-2 flex items-center gap-6">
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="taskUrgent" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"> Urgent</label>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="taskImportant" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"> Important</label>
                </div>
                <button id="add-task-btn" class="col-span-1 md:col-span-2 w-full py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition-all transform hover:scale-105">Add Task</button>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 kanban-board">
            <!-- To Do Column -->
            <div class="kanban-column bg-gray-100 dark:bg-gray-800 rounded-xl p-4 transition-colors duration-300" data-status="todo">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">To Do <span id="count-todo" class="px-3 py-1 bg-blue-200 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-sm font-semibold rounded-full">0</span></h2>
                <div id="tasks-todo" class="min-h-[200px]"></div>
            </div>
            <!-- In Progress Column -->
            <div class="kanban-column bg-gray-100 dark:bg-gray-800 rounded-xl p-4 transition-colors duration-300" data-status="inprogress">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">In Progress <span id="count-inprogress" class="px-3 py-1 bg-yellow-200 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 text-sm font-semibold rounded-full">0</span></h2>
                <div id="tasks-inprogress" class="min-h-[200px]"></div>
            </div>
            <!-- Completed Column -->
            <div class="kanban-column bg-gray-100 dark:bg-gray-800 rounded-xl p-4 transition-colors duration-300" data-status="completed">
                <h2 class="text-xl font-bold mb-4 flex items-center justify-between">Completed <span id="count-completed" class="px-3 py-1 bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-200 text-sm font-semibold rounded-full">0</span></h2>
                <div id="tasks-completed" class="min-h-[200px]"></div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div class="mt-12 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg">
             <h2 class="text-2xl font-bold mb-6 text-center">Task Analytics</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <div class="chart-container h-64 md:h-80"><canvas id="taskChart"></canvas></div>
                 <div class="chart-container h-64 md:h-80"><canvas id="priorityChart"></canvas></div>
             </div>
        </div>
    </div>

    <!-- Notification Bar -->
    <div id="notification-bar" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white max-w-sm transition-transform translate-x-[120%]" role="alert"></div>
    
    <!-- Custom Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="mb-6 text-gray-600 dark:text-gray-400">Are you sure you want to delete this task? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, Timestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        let db, auth;
        let userId = null;
        let tasks = [];
        let firestoreUnsubscribe = null;
        let taskToDeleteId = null;

        // Use environment variables provided by the platform
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        // --- DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const authMessage = document.getElementById('auth-message');
        const mainApp = document.getElementById('main-app');
        const notificationBar = document.getElementById('notification-bar');
        const deleteModal = document.getElementById('delete-modal');

        // --- UI FUNCTIONS ---
        function showNotification(message, type = 'info') {
            notificationBar.textContent = message;
            notificationBar.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white max-w-sm transition-transform'; // Reset classes
            
            const typeClasses = {
                error: 'bg-red-500',
                success: 'bg-green-500',
                info: 'bg-blue-500'
            };
            
            notificationBar.classList.add(typeClasses[type]);
            notificationBar.classList.remove('translate-x-[120%]');
            notificationBar.style.transform = 'translateX(0)';

            setTimeout(() => {
                notificationBar.style.transform = 'translateX(120%)';
            }, 3000);
        }

        // --- THEME MANAGEMENT ---
        function applyTheme(theme) {
            document.documentElement.classList.toggle('dark', theme === 'dark');
            localStorage.setItem('theme', theme);
            document.getElementById('themeToggle').textContent = theme === 'dark' ? '☀️' : '🌙';
            updateAnalytics(); // Redraw charts with new theme colors
        }

        // --- FIREBASE & AUTHENTICATION ---
        async function initApp() {
            if (!firebaseConfig) {
                authMessage.textContent = 'Firebase configuration is missing. The app cannot start.';
                showNotification('Configuration error.', 'error');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in.
                        userId = user.uid;
                        if(mainApp.classList.contains('hidden')){
                            authContainer.style.display = 'none';
                            mainApp.classList.remove('hidden');
                            document.getElementById('userIdDisplay').textContent = userId;
                            setupAppEventListeners();
                            loadTasks();
                        }
                    } else {
                        // User is signed out. Attempt to sign in.
                        authMessage.textContent = 'Authenticating...';
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                             console.error("Sign-in error:", error);
                             authMessage.textContent = `Authentication failed: ${error.message}`;
                             showNotification('Authentication failed.', 'error');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                authMessage.textContent = 'Failed to initialize the application.';
                showNotification('Initialization error.', 'error');
            }
        }
        
        // --- DATA HANDLING (FIRESTORE) ---
        function getTasksCollectionRef() {
            // Correct path for private user data
            return collection(db, 'artifacts', appId, 'users', userId, 'tasks');
        }
        
        function loadTasks() {
            if (!userId) return;
            
            const q = query(getTasksCollectionRef(), limit(100));
            
            if (firestoreUnsubscribe) firestoreUnsubscribe(); // Unsubscribe from previous listener
            
            firestoreUnsubscribe = onSnapshot(q, (snapshot) => {
                tasks = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Convert Firestore Timestamps to JS Dates for easier use
                    return {
                        id: doc.id,
                        ...data,
                        dueDate: data.dueDate ? data.dueDate.toDate() : null
                    };
                });
                renderAllUI();
            }, (error) => {
                console.error("Error fetching tasks: ", error);
                showNotification('Failed to load tasks.', 'error');
            });
        }

        async function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) {
                showNotification('Task title is required.', 'error');
                return;
            }
            const duration = Number(document.getElementById('taskDuration').value);
            const dueDateValue = document.getElementById('taskDueDate').value;
            const isUrgent = document.getElementById('taskUrgent').checked;
            const isImportant = document.getElementById('taskImportant').checked;

            const newTask = {
                title,
                description: document.getElementById('taskDescription').value.trim(),
                duration: duration > 0 ? duration : null,
                dueDate: dueDateValue ? Timestamp.fromDate(new Date(dueDateValue)) : null,
                isUrgent,
                isImportant,
                quadrant: getEisenhowerQuadrant(isUrgent, isImportant),
                status: 'todo',
                createdAt: serverTimestamp()
            };
            
            try {
                await addDoc(getTasksCollectionRef(), newTask);
                showNotification('Task added successfully!', 'success');
                // Reset form
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskDuration').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskUrgent').checked = false;
                document.getElementById('taskImportant').checked = false;
            } catch (error) {
                console.error("Error adding task: ", error);
                showNotification('Failed to add task.', 'error');
            }
        }
        
        function getEisenhowerQuadrant(isUrgent, isImportant) {
            if (isUrgent && isImportant) return 'Q1';   // Urgent & Important
            if (!isUrgent && isImportant) return 'Q2';  // Not Urgent & Important
            if (isUrgent && !isImportant) return 'Q3';   // Urgent & Not Important
            return 'Q4';                               // Not Urgent & Not Important
        }
        
        // --- UI RENDERING ---
        function renderAllUI() {
            renderTasks();
            updateAnalytics();
        }

        function renderTasks() {
            const containers = {
                todo: document.getElementById('tasks-todo'),
                inprogress: document.getElementById('tasks-inprogress'),
                completed: document.getElementById('tasks-completed')
            };
            Object.values(containers).forEach(c => c.innerHTML = '');

            tasks.forEach(task => {
                if (containers[task.status]) {
                    containers[task.status].appendChild(createTaskElement(task));
                }
            });

            document.getElementById('count-todo').textContent = tasks.filter(t => t.status === 'todo').length;
            document.getElementById('count-inprogress').textContent = tasks.filter(t => t.status === 'inprogress').length;
            document.getElementById('count-completed').textContent = tasks.filter(t => t.status === 'completed').length;
        }

        function createTaskElement(task) {
            const div = document.createElement('div');
            div.id = task.id;
            div.draggable = task.status !== 'completed';
            div.className = 'task bg-white dark:bg-gray-700 p-4 rounded-lg shadow-md mb-4 border-l-4 cursor-grab active:cursor-grabbing';
            
            const quadrantColors = {
                Q1: 'border-red-500', Q2: 'border-blue-500',
                Q3: 'border-yellow-500', Q4: 'border-gray-500'
            };
            div.classList.add(quadrantColors[task.quadrant]);

            div.innerHTML = `
                <h3 class="font-bold text-lg text-gray-900 dark:text-white">${task.title}</h3>
                ${task.description ? `<p class="text-gray-600 dark:text-gray-400 my-2">${task.description}</p>` : ''}
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-gray-500 dark:text-gray-300 mt-2">
                    <span class="font-semibold text-xs px-2 py-1 rounded-full text-white" style="background-color: var(--chart-${task.quadrant.toLowerCase()});">${task.quadrant}</span>
                    ${task.dueDate ? `<span>Due: ${task.dueDate.toLocaleDateString()}</span>` : ''}
                    ${task.duration ? `<span>${task.duration} min</span>` : ''}
                </div>
            `;
            
            // Add delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'mt-4 px-3 py-1 bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200 text-xs font-semibold rounded-full hover:bg-red-200 transition';
            deleteBtn.onclick = () => {
                taskToDeleteId = task.id;
                deleteModal.classList.remove('hidden');
            };
            div.appendChild(deleteBtn);
            
            // Drag and Drop listeners
            if (div.draggable) {
                div.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.id);
                    e.target.classList.add('dragging');
                });
                div.addEventListener('dragend', (e) => e.target.classList.remove('dragging'));
            }

            return div;
        }

        async function handleDrop(e) {
            e.preventDefault();
            const targetColumn = e.target.closest('.kanban-column');
            if (!targetColumn) return;
            
            targetColumn.classList.remove('drag-over');
            const taskId = e.dataTransfer.getData('text/plain');
            const newStatus = targetColumn.dataset.status;
            
            // Prevent dropping back into the same column if no change
            const originalTask = tasks.find(t => t.id === taskId);
            if (originalTask.status === newStatus) return;

            try {
                const taskDocRef = doc(getTasksCollectionRef(), taskId);
                await updateDoc(taskDocRef, { status: newStatus });
                showNotification('Task moved!', 'success');
                if (newStatus === 'completed') {
                    confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                }
            } catch (error) {
                console.error("Error updating task status: ", error);
                showNotification('Failed to move task.', 'error');
            }
        }
        
        // --- EVENT LISTENERS ---
        function setupAppEventListeners() {
            document.getElementById('add-task-btn').addEventListener('click', addTask);
            document.getElementById('logout-btn').addEventListener('click', () => {
                firebaseSignOut(auth).then(() => window.location.reload()).catch(console.error);
            });
            document.getElementById('themeToggle').addEventListener('click', () => {
                const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
            
            // Drag and drop for columns
            document.querySelectorAll('.kanban-column').forEach(column => {
                column.addEventListener('dragover', e => {
                    e.preventDefault();
                    e.currentTarget.classList.add('drag-over');
                });
                column.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over'));
                column.addEventListener('drop', handleDrop);
            });
            
            // Modal listeners
            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                taskToDeleteId = null;
            });
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (!taskToDeleteId) return;
                try {
                    await deleteDoc(doc(getTasksCollectionRef(), taskToDeleteId));
                    showNotification('Task deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting task: ", error);
                    showNotification('Failed to delete task.', 'error');
                } finally {
                    deleteModal.classList.add('hidden');
                    taskToDeleteId = null;
                }
            });
        }
        
        // --- ANALYTICS & CHARTS ---
        let taskChart, priorityChart;
        function setupCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { enabled: true }
                }
            };
            taskChart = new Chart(document.getElementById('taskChart').getContext('2d'), {
                type: 'doughnut', data: { labels: [], datasets: [] }, options: {...commonOptions, plugins: {...commonOptions.plugins, title: { display: true, text: 'Tasks by Status'}}}
            });
            priorityChart = new Chart(document.getElementById('priorityChart').getContext('2d'), {
                type: 'pie', data: { labels: [], datasets: [] }, options: {...commonOptions, plugins: {...commonOptions.plugins, title: { display: true, text: 'Tasks by Priority'}}}
            });
        }

        function updateAnalytics() {
            if (!taskChart) return; // Charts might not be initialized yet
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#f9fafb' : '#1f2937';
            const cardBg = isDarkMode ? 'var(--card-bg-dark)' : 'var(--card-bg-light)';
            
            // Update chart label colors
            taskChart.options.plugins.legend.labels.color = textColor;
            taskChart.options.plugins.title.color = textColor;
            priorityChart.options.plugins.legend.labels.color = textColor;
            priorityChart.options.plugins.title.color = textColor;

            // Task Status Data
            const statusCounts = tasks.reduce((acc, task) => ({...acc, [task.status]: (acc[task.status] || 0) + 1}), {});
            taskChart.data = {
                labels: ['To Do', 'In Progress', 'Completed'],
                datasets: [{
                    data: [statusCounts.todo || 0, statusCounts.inprogress || 0, statusCounts.completed || 0],
                    backgroundColor: ['var(--chart-todo)','var(--chart-inprogress)','var(--chart-completed)'],
                    borderColor: cardBg,
                    borderWidth: 4
                }]
            };
            
            // Priority Quadrant Data
            const priorityCounts = tasks.reduce((acc, task) => ({...acc, [task.quadrant]: (acc[task.quadrant] || 0) + 1}), {});
            priorityChart.data = {
                labels: ['Q1: Do', 'Q2: Schedule', 'Q3: Delegate', 'Q4: Eliminate'],
                datasets: [{
                    data: [priorityCounts.Q1 || 0, priorityCounts.Q2 || 0, priorityCounts.Q3 || 0, priorityCounts.Q4 || 0],
                    backgroundColor: ['var(--chart-q1)','var(--chart-q2)','var(--chart-q3)','var(--chart-q4)'],
                    borderColor: cardBg,
                    borderWidth: 4
                }]
            };

            taskChart.update();
            priorityChart.update();
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Apply saved theme on load
            applyTheme(localStorage.getItem('theme') || 'light');
            setupCharts();
            initApp();
        });
    </script>
</body>
</html>
